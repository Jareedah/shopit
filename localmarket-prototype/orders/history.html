<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase History - LocalMarket</title>
    <link rel="stylesheet" href="../assets/css/base/reset.css">
    <link rel="stylesheet" href="../assets/css/base/variables.css">
    <link rel="stylesheet" href="../assets/css/base/typography.css">
    <link rel="stylesheet" href="../assets/css/layout/header.css">
    <link rel="stylesheet" href="../assets/css/components/buttons.css">
    <link rel="stylesheet" href="../assets/css/components/forms.css">
    <link rel="stylesheet" href="../assets/css/components/cards.css">
    <link rel="stylesheet" href="../assets/css/pages/orders.css">
    <link rel="stylesheet" href="../assets/css/components/escrow.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">LocalMarket</h1>
            <nav class="navigation">
                <a href="../dashboard/index.html" class="nav-link">Dashboard</a>
                <a href="../search/index.html" class="nav-link">Search</a>
                <a href="../index.html" class="nav-link">Home</a>
                <span id="userWelcome"></span>
                <a href="#" id="logoutLink" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>üõí My Purchase History</h2>
                <p>Track all your purchases and their delivery status</p>
            </div>

            <div class="order-history-container">
                <div class="orders-header">
                    <h3>üõí Your Purchases</h3>
                    <div class="orders-filters">
                        <select id="statusFilter" onchange="filterBuyerOrders()">
                            <option value="">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshBuyerOrders()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div id="buyerOrdersList" class="orders-container">
                    <div class="loading-state">Loading your order history...</div>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/core/api.js"></script>
    <script src="../assets/js/core/utils.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/modules/escrow.js"></script>
    <script src="../assets/js/modules/escrow-workflow.js"></script>
    
    <script>
        let buyerOrders = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!Auth.isLoggedIn()) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const user = Auth.getCurrentUser();
            document.getElementById('userWelcome').textContent = `Welcome, ${user.username}`;
            
            // Load buyer orders
            loadBuyerOrders(user.id);
            
            // Logout functionality
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                Auth.logout();
                window.location.href = '../auth/login.html';
            });
        });
        
        async function loadBuyerOrders(buyerId) {
            try {
                const container = document.getElementById('buyerOrdersList');
                container.innerHTML = '<div class="loading-state">Loading your orders...</div>';
                
                // Get buyer orders from global API
                const response = await fetch('../api/orders/buyer-orders.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ buyerId: buyerId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    buyerOrders = result.orders || [];
                } else {
                    console.error('Failed to load buyer orders:', result.message);
                    buyerOrders = [];
                }
                
                if (buyerOrders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Orders Yet</h3>
                            <p>You haven't made any purchases yet.</p>
                            <a href="../search/index.html" class="btn btn-primary">Start Shopping</a>
                        </div>
                    `;
                    return;
                }
                
                // Display orders
                displayBuyerOrders(buyerOrders);
                
            } catch (error) {
                console.error('Error loading buyer orders:', error);
                document.getElementById('buyerOrdersList').innerHTML = `
                    <div class="error-state">
                        <p>Error loading orders: ${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }
        
        function displayBuyerOrders(orders) {
            const container = document.getElementById('buyerOrdersList');
            
            let ordersHtml = '<div class="buyer-orders-list">';
            
            orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(order => {
                const statusColor = getOrderStatusColor(order.status);
                const escrowStatus = order.escrow_status || 'pending';
                
                ordersHtml += `
                    <div class="order-card" data-order-id="${order.id}">
                        <div class="order-header">
                            <div class="order-info">
                                <h4>${order.listingTitle}</h4>
                                <p class="seller-info">Sold by: ${order.sellerName || order.sellerId}</p>
                            </div>
                            <div class="order-status">
                                <span class="status-badge" style="background-color: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem;">
                                    ${formatOrderStatus(order.status)}
                                </span>
                                ${getBuyerEscrowBadge(order)}
                            </div>
                        </div>
                        
                        <div class="order-details">
                            <div class="detail-row">
                                <span>Order ID:</span>
                                <span>${order.id}</span>
                            </div>
                            <div class="detail-row">
                                <span>Quantity:</span>
                                <span>${order.quantity}</span>
                            </div>
                            <div class="detail-row">
                                <span>Total Paid:</span>
                                <span>$${order.total_amount.toFixed(2)}</span>
                            </div>
                            <div class="detail-row">
                                <span>Order Date:</span>
                                <span>${new Date(order.created_at).toLocaleDateString()}</span>
                            </div>
                            ${order.tracking_number ? `
                                <div class="detail-row">
                                    <span>Tracking:</span>
                                    <span>${order.tracking_number}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="order-actions">
                            ${generateBuyerOrderActions(order)}
                        </div>
                    </div>
                `;
            });
            
            ordersHtml += '</div>';
            container.innerHTML = ordersHtml;
        }
        
        function generateBuyerOrderActions(order) {
            const actions = [];
            
            switch (order.status) {
                case 'pending':
                    actions.push(`<button class="btn btn-success btn-sm" onclick="releaseFundsNow('${order.id}')">üí∞ Release Funds Now</button>`);
                    actions.push(`<button class="btn btn-secondary btn-sm" onclick="contactSeller('${order.id}')">üí¨ Contact Seller</button>`);
                    actions.push(`<button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.id}')">‚ùå Cancel Order</button>`);
                    break;
                    
                case 'confirmed':
                    actions.push(`<button class="btn btn-success btn-sm" onclick="releaseFundsNow('${order.id}')">üí∞ Release Funds Now</button>`);
                    actions.push(`<button class="btn btn-secondary btn-sm" onclick="contactSeller('${order.id}')">üí¨ Contact Seller</button>`);
                    break;
                    
                case 'shipped':
                    actions.push(`<button class="btn btn-success btn-sm" onclick="confirmDeliveryAndRelease('${order.id}')">‚úÖ Confirm & Release Funds</button>`);
                    actions.push(`<button class="btn btn-primary btn-sm" onclick="releaseFundsNow('${order.id}')">üí∞ Release Funds Now</button>`);
                    actions.push(`<button class="btn btn-secondary btn-sm" onclick="trackOrder('${order.id}')">üì¶ Track Package</button>`);
                    break;
                    
                case 'delivered':
                    actions.push(`<button class="btn btn-success btn-sm" onclick="confirmDeliveryAndRelease('${order.id}')">‚úÖ Confirm & Release Funds</button>`);
                    actions.push(`<button class="btn btn-primary btn-sm" onclick="releaseFundsNow('${order.id}')">üí∞ Release Funds Now</button>`);
                    actions.push(`<button class="btn btn-warning btn-sm" onclick="disputeOrder('${order.id}')">‚ö†Ô∏è Report Issue</button>`);
                    break;
                    
                case 'release_requested':
                    actions.push(`<button class="btn btn-success btn-sm" onclick="approveFundRelease('${order.id}')">‚úÖ Approve Fund Release</button>`);
                    actions.push(`<button class="btn btn-danger btn-sm" onclick="denyFundRelease('${order.id}')">‚ùå Deny Release</button>`);
                    actions.push(`<button class="btn btn-warning btn-sm" onclick="disputeOrder('${order.id}')">‚ö†Ô∏è Report Issue</button>`);
                    break;
                    
                case 'completed':
                    actions.push(`<button class="btn btn-success btn-sm" disabled style="opacity: 0.6;">üéâ Transaction Complete</button>`);
                    actions.push(`<button class="btn btn-secondary btn-sm" onclick="leaveReview('${order.id}')">‚≠ê Leave Review</button>`);
                    break;
                    
                case 'cancelled':
                    actions.push(`<button class="btn btn-secondary btn-sm" disabled style="opacity: 0.6;">‚ùå Cancelled</button>`);
                    break;
            }
            
            return actions.join(' ');
        }
        
        function getOrderStatusColor(status) {
            const colors = {
                'pending': '#f59e0b',
                'confirmed': '#3b82f6',
                'processing': '#8b5cf6',
                'shipped': '#06b6d4',
                'delivered': '#10b981',
                'release_requested': '#f59e0b',
                'completed': '#059669',
                'cancelled': '#6b7280',
                'disputed': '#dc2626'
            };
            return colors[status] || '#6b7280';
        }

        function getBuyerEscrowBadge(order) {
            if (order.status === 'completed' || order.escrow_status === 'funds_released') {
                return `<span class="escrow-badge" style="background: #059669; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; margin-top: 0.25rem; display: block;">
                    üéâ Transaction Complete
                </span>`;
            } else if (order.escrow_status === 'funds_held') {
                return `<span class="escrow-badge" style="background: #0891b2; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; margin-top: 0.25rem; display: block;">
                    üîí Payment Secured
                </span>`;
            }
            return '';
        }
        
        function formatOrderStatus(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'processing': 'Processing',
                'shipped': 'Shipped',
                'delivered': 'Delivered',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'disputed': 'Disputed'
            };
            return statusMap[status] || status;
        }
        
        function filterBuyerOrders() {
            const status = document.getElementById('statusFilter').value;
            const filteredOrders = status ? buyerOrders.filter(o => o.status === status) : buyerOrders;
            displayBuyerOrders(filteredOrders);
        }
        
        function refreshBuyerOrders() {
            const user = Auth.getCurrentUser();
            loadBuyerOrders(user.id);
            showNotification('Order history refreshed!', 'success');
        }
        
        // WORKING buyer order functions
        async function releaseFundsNow(orderId) {
            if (!confirm('Release funds to seller immediately? This will complete the transaction.')) {
                return;
            }
            
            try {
                showNotification('üí∞ Releasing funds to seller...', 'info');
                
                const response = await fetch('../api/orders/update-status.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        newStatus: 'completed',
                        escrowStatus: 'funds_released'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('üí∞ Money transferred to seller! Transaction completed successfully.', 'success');
                    
                    // Wait a moment for server update, then refresh
                    setTimeout(() => {
                        refreshBuyerOrders();
                    }, 500);
                } else {
                    showNotification('Error releasing funds: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Error releasing funds: ' + error.message, 'error');
            }
        }
        
        async function confirmDeliveryAndRelease(orderId) {
            if (!confirm('Confirm delivery and release funds to seller?')) {
                return;
            }
            
            try {
                showNotification('‚úÖ Confirming delivery and releasing funds...', 'info');
                
                const response = await fetch('../api/orders/update-status.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        newStatus: 'completed',
                        escrowStatus: 'funds_released'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('üí∞ Money transferred to seller! Delivery confirmed and transaction completed.', 'success');
                    
                    // Wait a moment for server update, then refresh
                    setTimeout(() => {
                        refreshBuyerOrders();
                    }, 500);
                } else {
                    showNotification('Error confirming delivery: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Error confirming delivery: ' + error.message, 'error');
            }
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('Cancel this order? This will trigger an automatic refund.')) {
                return;
            }
            
            try {
                showNotification('‚ùå Cancelling order...', 'info');
                
                const response = await fetch('../api/orders/update-status.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        newStatus: 'cancelled'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Order cancelled. Automatic refund processed.', 'success');
                    refreshBuyerOrders();
                } else {
                    showNotification('Error cancelling order: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Error cancelling order: ' + error.message, 'error');
            }
        }
        
        async function approveFundRelease(orderId) {
            if (!confirm('Approve fund release to seller? This will complete the transaction.')) {
                return;
            }
            
            try {
                showNotification('‚úÖ Approving fund release...', 'info');
                
                const response = await fetch('../api/orders/update-status.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        newStatus: 'completed',
                        escrowStatus: 'funds_released'
                    })
                });
                
                const result = await response.json();
                console.log('Fund release approval result:', result);
                
                if (result.success) {
                    showNotification('üí∞ Money transferred to seller! Transaction completed.', 'success');
                    
                    // Wait a moment for server update, then refresh
                    setTimeout(() => {
                        refreshBuyerOrders();
                    }, 500);
                } else {
                    showNotification('Error approving release: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Error approving release: ' + error.message, 'error');
            }
        }
        
        async function denyFundRelease(orderId) {
            const reason = prompt('Why are you denying the fund release? (Optional)');
            
            try {
                showNotification('‚ùå Denying fund release...', 'info');
                
                // For now, just keep status as delivered
                showNotification('Fund release denied. Seller has been notified. You can still release funds manually or report an issue.', 'info');
                
            } catch (error) {
                showNotification('Error denying release: ' + error.message, 'error');
            }
        }
        
        // Placeholder functions for future features
        function contactSeller(orderId) {
            showNotification('üí¨ Seller contact system coming soon', 'info');
        }
        
        function trackOrder(orderId) {
            showNotification('üì¶ Package tracking system coming soon', 'info');
        }
        
        function disputeOrder(orderId) {
            showNotification('‚ö†Ô∏è Dispute system coming soon', 'info');
        }
        
        function leaveReview(orderId) {
            showNotification('‚≠ê Review system coming soon', 'info');
        }
        
        function viewOrderDetails(orderId) {
            showNotification('üìã Detailed order view coming soon', 'info');
        }
        
        function showNotification(message, type = 'info') {
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    </script>
    
    <style>
        .order-history-container { max-width: 1000px; margin: 0 auto; }
        .orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .orders-filters { display: flex; gap: 10px; align-items: center; }
        .buyer-orders-list { display: flex; flex-direction: column; gap: 20px; }
        .order-card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .order-info h4 { margin: 0 0 5px 0; color: #333; }
        .seller-info { color: #666; font-size: 0.9rem; margin: 0; }
        .order-status { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .order-details { margin-bottom: 15px; }
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-row:last-child { border-bottom: none; }
        .order-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .empty-state, .error-state { text-align: center; padding: 40px; }
        .loading-state { text-align: center; padding: 40px; color: #666; }
    </style>
</body>
</html>