<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase History - Shopit</title>
    <link rel="stylesheet" href="../assets/css/themes/apple-inspired.css">
    <link href="https://cdn.jsdelivr.net/npm/phosphor-icons@1.4.2/src/css/icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/pages/orders.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo"><i class="ph ph-shopping-bag"></i> Shopit</h1>
            <nav class="navigation">
                <a href="../dashboard/index.html" class="nav-link">Dashboard</a>
                <span id="userWelcome"></span>
                <a href="#" id="logoutLink" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header" style="text-align: center; padding: 40px 0;">
                <h2 class="text-gradient-apple">My Purchase History</h2>
                <p>Track all your purchases and their delivery status</p>
            </div>
            <div id="buyerOrdersList" class="orders-container">
                <div class="loading-state">Loading your order history...</div>
            </div>
        </div>
    </main>

    <script src="../assets/js/core/api.js"></script>
    <script src="../assets/js/core/utils.js"></script>
    <script src="../assets/js/core/apple-notifications.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    
    <script>
        let buyerOrders = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn()) {
                window.location.href = '../auth/login.html';
                return;
            }
            const user = Auth.getCurrentUser();
            document.getElementById('userWelcome').textContent = `Welcome, ${user.username}`;
            loadBuyerOrders(user.id);
            document.getElementById('logoutLink').addEventListener('click', (e) => { e.preventDefault(); Auth.logout(); });
        });
        
        async function loadBuyerOrders(buyerId) {
            const container = document.getElementById('buyerOrdersList');
            container.innerHTML = '<div class="loading-state">Loading your orders...</div>';
            try {
                const response = await API.post('../api/orders/buyer-orders.php', { buyerId });
                if (response.success) {
                    buyerOrders = response.orders || [];
                    displayBuyerOrders(buyerOrders);
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                container.innerHTML = `<div class="error-state"><p>Error: ${error.message}</p></div>`;
            }
        }
        
        function displayBuyerOrders(orders) {
            const container = document.getElementById('buyerOrdersList');
            if (orders.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>No Orders Yet</h3><p>You haven't made any purchases yet.</p><a href="../search/index.html" class="btn btn-primary">Start Shopping</a></div>`;
                return;
            }
            let html = '<div class="buyer-orders-list">';
            orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(order => {
                html += `
                    <div class="order-card" data-order-id="${order.id}">
                        <div class="order-header">
                            <div class="order-info"><h4>${order.listingTitle}</h4><p class="seller-info">Sold by: ${order.sellerName || order.sellerId}</p></div>
                            <div class="order-status"><span class="status-badge" style="background-color: ${getOrderStatusColor(order.status)}; color: white;">${formatOrderStatus(order.status)}</span></div>
                        </div>
                        <div class="order-details">
                            <div class="detail-row"><span>Total Paid:</span><span>$${order.total_amount.toFixed(2)}</span></div>
                            <div class="detail-row"><span>Order Date:</span><span>${new Date(order.created_at).toLocaleDateString()}</span></div>
                        </div>
                        <div class="order-actions">${generateBuyerOrderActions(order)}</div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function generateBuyerOrderActions(order) {
            const actions = [];
            if (order.status === 'release_requested') {
                actions.push(`<button class="btn btn-success btn-sm" onclick="approveFundRelease('${order.id}')">✅ Approve Release</button>`);
                actions.push(`<button class="btn btn-warning btn-sm" onclick="denyFundRelease('${order.id}')">⚠️ Deny Release</button>`);
            } else if (order.status === 'completed') {
                actions.push(`<button class="btn btn-secondary btn-sm" onclick="leaveReview('${order.id}')">⭐ Leave Review</button>`);
            }
            return actions.join(' ');
        }

        async function approveFundRelease(orderId) {
            const confirmed = await showAppleNotification.confirm({
                title: 'Approve Fund Release?',
                message: 'This will complete the transaction and transfer your payment to the seller. This action cannot be undone.',
                confirmText: 'Yes, Release Funds',
                icon: 'ph-check-circle',
                iconColor: 'var(--apple-green)'
            });

            if (confirmed) {
                try {
                    const response = await API.post('../api/orders/update-status.php', {
                        orderId: orderId,
                        newStatus: 'completed',
                        escrowStatus: 'funds_released'
                    });

                    if (response.success) {
                        showAppleNotification.success('Funds Released!', 'The transaction is now complete.');
                        refreshBuyerOrders();
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    showAppleNotification.error('Action Failed', error.message);
                }
            }
        }
        
        function refreshBuyerOrders() {
            const user = Auth.getCurrentUser();
            if (user) loadBuyerOrders(user.id);
        }

        // Placeholder functions
        function denyFundRelease(orderId) { showAppleNotification.warning('Release Denied', 'The seller has been notified. Please contact them or support to resolve the issue.'); }
        function leaveReview(orderId) { showAppleNotification.info('Coming Soon', 'This would open a review submission form.'); }
        function getOrderStatusColor(status) { return { completed: '#28a745', release_requested: '#f59e0b' }[status] || '#6c757d'; }
        function formatOrderStatus(status) { return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); }
    </script>
</body>
</html>