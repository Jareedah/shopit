<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Management - Shopit</title>
    
    <!-- Apple System Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SF Symbols Alternative - iOS-style icons -->
    <link href="https://cdn.jsdelivr.net/npm/phosphor-icons@1.4.2/src/css/icons.min.css" rel="stylesheet">
    
    <!-- Original CSS (preserved) -->
    <link rel="stylesheet" href="../assets/css/base/reset.css">
    <link rel="stylesheet" href="../assets/css/base/variables.css">
    <link rel="stylesheet" href="../assets/css/base/typography.css">
    <link rel="stylesheet" href="../assets/css/layout/header.css">
    <link rel="stylesheet" href="../assets/css/components/buttons.css">
    <link rel="stylesheet" href="../assets/css/components/forms.css">
    <link rel="stylesheet" href="../assets/css/components/cards.css">
    <link rel="stylesheet" href="../assets/css/pages/orders.css">
    <link rel="stylesheet" href="../assets/css/components/seller-orders.css">
    <link rel="stylesheet" href="../assets/css/components/escrow.css">
    
    <!-- Apple-Inspired Theme Coating - LOADED LAST FOR PRIORITY -->
    <link rel="stylesheet" href="../assets/css/themes/apple-inspired.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">
                <i class="ph ph-shopping-bag" style="margin-right: 8px; vertical-align: middle;"></i>
                Shopit
            </h1>
            <nav class="navigation">
                <a href="../dashboard/index.html" class="nav-link">Dashboard</a>
                <a href="../search/index.html" class="nav-link">Search</a>
                <a href="../index.html" class="nav-link">Home</a>
                <span id="userWelcome"></span>
                <a href="#" id="logoutLink" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header" style="text-align: center; padding: 40px 0; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: var(--apple-radius-lg); margin-bottom: 32px; box-shadow: var(--apple-shadow-medium);">
                <div style="color: var(--apple-purple); font-size: 48px; margin-bottom: 16px;">
                    <i class="ph ph-chart-line-up"></i>
                </div>
                <h2 class="text-gradient-apple" style="font-size: var(--apple-font-size-title1); margin-bottom: 8px;">Sales Management</h2>
                <p style="color: var(--apple-text-secondary); font-size: var(--apple-font-size-body); margin-bottom: 24px;">Manage all your incoming orders, sales, and earnings</p>
                
                <div class="order-tabs" style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                    <button class="tab-btn active" onclick="showTab('seller')" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--apple-blue); color: white; border: none; border-radius: var(--apple-radius-full); font-weight: 600;">
                        <i class="ph ph-storefront"></i>
                        Orders Received
                    </button>
                    <button class="tab-btn" onclick="showTab('buyer')" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--apple-gray-light); color: var(--apple-text-secondary); border: none; border-radius: var(--apple-radius-full); font-weight: 600;">
                        <i class="ph ph-shopping-cart"></i>
                        Orders Placed
                    </button>
                    <button class="tab-btn" onclick="showTab('analytics')" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--apple-gray-light); color: var(--apple-text-secondary); border: none; border-radius: var(--apple-radius-full); font-weight: 600;">
                        <i class="ph ph-chart-bar"></i>
                        Sales Analytics
                    </button>
                </div>
            </div>

            <!-- Seller Orders Tab -->
            <div id="sellerTab" class="tab-content active">
                <div class="orders-header">
                    <h3>üõçÔ∏è Orders Received <span id="newOrdersBadge" class="notification-badge" style="display: none;">0</span></h3>
                    <div class="orders-filters">
                        <select id="statusFilter" onchange="filterOrders()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshOrders()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div id="sellerOrdersList" class="orders-container">
                    <div class="loading-state">Loading your orders...</div>
                </div>
            </div>

            <!-- Buyer Orders Tab -->
            <div id="buyerTab" class="tab-content">
                <div class="orders-header">
                    <h3>üõí Orders Placed</h3>
                </div>
                
                <div id="buyerOrdersList" class="orders-container">
                    <div class="info-message">
                        <p>Your purchase history would appear here</p>
                        <p>This feature will be enhanced in the next phase</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <div class="analytics-header">
                    <h3>üìä Sales Analytics</h3>
                </div>
                
                <div id="salesAnalytics" class="analytics-container">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="stat-number" id="totalEarnings">$0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="analytics-card">
                            <div class="stat-number" id="pendingEarnings">$0.00</div>
                            <div class="stat-label">Pending in Escrow</div>
                        </div>
                        <div class="analytics-card">
                            <div class="stat-number" id="totalOrders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="analytics-card">
                            <div class="stat-number" id="completedOrders">0</div>
                            <div class="stat-label">Completed Orders</div>
                        </div>
                    </div>
                    
                    <div class="recent-sales">
                        <h4>Recent Sales Activity</h4>
                        <div id="recentSales" class="sales-list">
                            <div class="loading-state">Loading sales data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/core/api.js"></script>
    <script src="../assets/js/core/utils.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/modules/escrow.js"></script>
    <script src="../assets/js/modules/escrow-workflow.js"></script>
    <script src="../assets/js/modules/seller-orders.js"></script>
    
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn { padding: 10px 20px; border: 1px solid #ccc; background: #f8f9fa; cursor: pointer; }
        .tab-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .orders-filters { display: flex; gap: 10px; align-items: center; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .analytics-card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #28a745; }
        .stat-label { color: #6c757d; margin-top: 5px; }
        .info-message { text-align: center; padding: 40px; color: #6c757d; }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!Auth.isLoggedIn()) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const user = Auth.getCurrentUser();
            document.getElementById('userWelcome').textContent = `Welcome, ${user.username}`;
            
            // Initialize seller orders
            initializeOrdersPage(user.id);
            
            // Logout functionality
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                Auth.logout();
                window.location.href = '../auth/login.html';
            });
        });
        
        async function initializeOrdersPage(userId) {
            try {
                // Initialize seller orders system
                if (typeof SellerOrders !== 'undefined') {
                    await SellerOrders.init(userId);
                    SellerOrders.displaySellerOrders('sellerOrdersList', 20); // Show more orders
                    updateAnalytics(userId);
                }
            } catch (error) {
                console.error('Error initializing orders page:', error);
                document.getElementById('sellerOrdersList').innerHTML = `
                    <div class="error-state">
                        <p>Error loading orders: ${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function filterOrders() {
            const status = document.getElementById('statusFilter').value;
            // Would filter orders by status
            showNotification(`Filtering by status: ${status || 'All'}`, 'info');
        }
        
        function refreshOrders() {
            const user = Auth.getCurrentUser();
            initializeOrdersPage(user.id);
            showNotification('Orders refreshed!', 'success');
        }
        
        function updateAnalytics(userId) {
            try {
                const allOrders = JSON.parse(localStorage.getItem('sellerOrders') || '[]');
                const userOrders = allOrders.filter(o => o.sellerId === userId);
                
                const totalEarnings = userOrders
                    .filter(o => o.status === 'completed')
                    .reduce((sum, o) => sum + (o.seller_amount || 0), 0);
                
                const pendingEarnings = userOrders
                    .filter(o => o.escrow_status === 'funds_held')
                    .reduce((sum, o) => sum + (o.seller_amount || 0), 0);
                
                const completedCount = userOrders.filter(o => o.status === 'completed').length;
                
                document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
                document.getElementById('pendingEarnings').textContent = `$${pendingEarnings.toFixed(2)}`;
                document.getElementById('totalOrders').textContent = userOrders.length;
                document.getElementById('completedOrders').textContent = completedCount;
                
                // Update recent sales
                const recentSales = userOrders
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
                
                const salesListHtml = recentSales.length > 0 ? 
                    recentSales.map(sale => `
                        <div class="sale-item">
                            <div class="sale-info">
                                <strong>${sale.listingTitle}</strong>
                                <p>Sold to: ${sale.buyerName}</p>
                            </div>
                            <div class="sale-amount">$${sale.seller_amount.toFixed(2)}</div>
                        </div>
                    `).join('') :
                    '<div class="info-message"><p>No sales yet</p></div>';
                
                document.getElementById('recentSales').innerHTML = salesListHtml;
                
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }
        
        function showNotification(message, type = 'info') {
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    </script>

    <!-- Apple-Inspired Mobile Navigation -->
    <nav class="apple-bottom-nav">
        <a href="../index.html" class="apple-nav-item">
            <div class="apple-nav-icon">
                <i class="ph ph-house"></i>
            </div>
            Home
        </a>
        <a href="../search/index.html" class="apple-nav-item">
            <div class="apple-nav-icon">
                <i class="ph ph-magnifying-glass"></i>
            </div>
            Browse
        </a>
        <a href="../listings/create.html" class="apple-nav-item">
            <div class="apple-nav-icon">
                <i class="ph ph-plus-circle"></i>
            </div>
            Sell
        </a>
        <a href="index.html" class="apple-nav-item">
            <div class="apple-nav-icon">
                <i class="ph ph-squares-four"></i>
            </div>
            Dashboard
        </a>
        <a href="orders.html" class="apple-nav-item active">
            <div class="apple-nav-icon">
                <i class="ph ph-chart-line-up"></i>
            </div>
            Sales
        </a>
    </nav>

    <!-- Apple-Inspired Floating Action Button -->
    <button class="apple-fab" onclick="window.location.href='../listings/create.html'" title="Create Listing">
        <i class="ph ph-plus" style="font-size: 24px;"></i>
    </button>
</body>
</html>