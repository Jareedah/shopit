<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Listing Form - LocalMarket</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .debug-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>üîç Debug Listing Form</h1>
    
    <div class="debug-info">
        <h3>Debug Information</h3>
        <div id="debugOutput">Loading...</div>
    </div>

    <form id="debugForm">
        <div class="form-group">
            <label for="title">Title*</label>
            <input type="text" id="title" required>
        </div>
        
        <div class="form-group">
            <label for="description">Description*</label>
            <textarea id="description" required></textarea>
        </div>
        
        <div class="form-group">
            <label for="price">Price*</label>
            <input type="number" id="price" step="0.01" required>
        </div>
        
        <div class="form-group">
            <label for="stock">Stock*</label>
            <input type="number" id="stock" value="1" required>
        </div>
        
        <div class="form-group">
            <label>Sale Type*</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="saleType" value="immediate" id="saleTypeImmediate">
                    Immediate Execution
                </label>
                <label class="radio-option">
                    <input type="radio" name="saleType" value="delivery_based" id="saleTypeDelivery" checked>
                    Delivery-Based
                </label>
            </div>
        </div>
        
        <div class="form-group" id="deliveryTimeGroup">
            <label for="deliveryTime">Delivery Time*</label>
            <select id="deliveryTime">
                <option value="24">24 hours</option>
                <option value="72" selected>72 hours</option>
                <option value="168">1 week</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="location">Location*</label>
            <input type="text" id="location" readonly>
            <button type="button" id="detectLocation" class="btn-secondary">Detect Location</button>
            <button type="button" id="manualLocation" class="btn-secondary">Manual Entry</button>
        </div>
        
        <div class="form-group">
            <label>Images</label>
            <input type="file" id="fileUpload" multiple accept="image/*" style="display: none;">
            <button type="button" id="uploadButton" class="btn-secondary">Upload Images</button>
            <div id="imagePreview"></div>
        </div>
        
        <button type="submit" class="btn-primary">Create Listing</button>
        <button type="button" id="testButton" class="btn-secondary">Test Functions</button>
    </form>

    <script src="assets/js/core/api.js"></script>
    <script src="assets/js/modules/auth.js"></script>
    
    <script>
        let uploadedImages = [];
        let debugLog = [];
        
        function addDebugLog(message) {
            debugLog.push(`${new Date().toLocaleTimeString()}: ${message}`);
            document.getElementById('debugOutput').innerHTML = debugLog.join('<br>');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('DOM loaded, initializing...');
            
            // Check authentication
            if (typeof Auth === 'undefined') {
                addDebugLog('ERROR: Auth module not loaded');
                return;
            }
            
            if (!Auth.isLoggedIn()) {
                addDebugLog('ERROR: User not logged in');
                window.location.href = 'auth/login.html';
                return;
            }
            
            addDebugLog('User authenticated, setting up form...');
            
            try {
                setupFormHandlers();
                addDebugLog('Form handlers setup complete');
            } catch (error) {
                addDebugLog('ERROR setting up form: ' + error.message);
            }
        });
        
        function setupFormHandlers() {
            // Sale type toggle
            const immediateRadio = document.getElementById('saleTypeImmediate');
            const deliveryRadio = document.getElementById('saleTypeDelivery');
            const deliveryTimeGroup = document.getElementById('deliveryTimeGroup');
            
            function toggleDeliveryTime() {
                try {
                    if (immediateRadio.checked) {
                        deliveryTimeGroup.style.display = 'none';
                        addDebugLog('Delivery time hidden (immediate selected)');
                    } else {
                        deliveryTimeGroup.style.display = 'block';
                        addDebugLog('Delivery time shown (delivery-based selected)');
                    }
                } catch (error) {
                    addDebugLog('ERROR in toggleDeliveryTime: ' + error.message);
                }
            }
            
            immediateRadio.addEventListener('change', toggleDeliveryTime);
            deliveryRadio.addEventListener('change', toggleDeliveryTime);
            toggleDeliveryTime(); // Initial setup
            
            // Image upload
            document.getElementById('uploadButton').addEventListener('click', function() {
                addDebugLog('Upload button clicked');
                document.getElementById('fileUpload').click();
            });
            
            document.getElementById('fileUpload').addEventListener('change', function(e) {
                addDebugLog('Files selected: ' + e.target.files.length);
                handleImageUpload(e);
            });
            
            // Location detection
            document.getElementById('detectLocation').addEventListener('click', function() {
                addDebugLog('Detect location clicked');
                detectLocation();
            });
            
            document.getElementById('manualLocation').addEventListener('click', function() {
                addDebugLog('Manual location clicked');
                const address = prompt('Enter location:');
                if (address) {
                    document.getElementById('location').value = address;
                    addDebugLog('Location set manually: ' + address);
                }
            });
            
            // Form submission
            document.getElementById('debugForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addDebugLog('Form submitted, processing...');
                handleFormSubmit();
            });
            
            // Test button
            document.getElementById('testButton').addEventListener('click', function() {
                testAllFunctions();
            });
        }
        
        function handleImageUpload(e) {
            try {
                const files = Array.from(e.target.files);
                uploadedImages = uploadedImages.concat(files);
                
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';
                
                uploadedImages.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; margin: 5px; border: 1px solid #ccc;';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
                
                addDebugLog(`Images uploaded: ${files.length}, Total: ${uploadedImages.length}`);
            } catch (error) {
                addDebugLog('ERROR in handleImageUpload: ' + error.message);
            }
        }
        
        function detectLocation() {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const location = `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                            document.getElementById('location').value = location;
                            addDebugLog('Location detected: ' + location);
                        },
                        function(error) {
                            addDebugLog('Geolocation error: ' + error.message);
                        }
                    );
                } else {
                    addDebugLog('Geolocation not supported');
                }
            } catch (error) {
                addDebugLog('ERROR in detectLocation: ' + error.message);
            }
        }
        
        async function handleFormSubmit() {
            try {
                // Get form data
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const price = document.getElementById('price').value;
                const stock = document.getElementById('stock').value;
                const location = document.getElementById('location').value;
                const saleType = document.querySelector('input[name="saleType"]:checked').value;
                const deliveryTime = document.getElementById('deliveryTime').value;
                
                addDebugLog('Form data collected:');
                addDebugLog(`Title: ${title}`);
                addDebugLog(`Description: ${description}`);
                addDebugLog(`Price: ${price}`);
                addDebugLog(`Stock: ${stock}`);
                addDebugLog(`Location: ${location}`);
                addDebugLog(`Sale Type: ${saleType}`);
                addDebugLog(`Delivery Time: ${deliveryTime}`);
                addDebugLog(`Images: ${uploadedImages.length}`);
                
                // Validate required fields
                if (!title || !description || !price || !stock || !location) {
                    throw new Error('Missing required fields');
                }
                
                // Prepare data
                const listingData = {
                    title: title,
                    description: description,
                    price: parseFloat(price),
                    stock: parseInt(stock),
                    sale_type: saleType,
                    delivery_time_hours: saleType === 'immediate' ? 0 : parseInt(deliveryTime),
                    location: { address: location, lat: 0, lng: 0 },
                    sellerId: Auth.getCurrentUser().id
                };
                
                addDebugLog('Listing data prepared: ' + JSON.stringify(listingData));
                
                // Create FormData
                const formData = new FormData();
                formData.append('listingData', JSON.stringify(listingData));
                
                uploadedImages.forEach((file, index) => {
                    formData.append('images[]', file);
                });
                
                addDebugLog('FormData created, submitting to API...');
                
                // Submit to API
                const response = await fetch('api/listings/create.php', {
                    method: 'POST',
                    body: formData
                });
                
                addDebugLog(`API response status: ${response.status}`);
                
                const result = await response.json();
                addDebugLog('API result: ' + JSON.stringify(result));
                
                if (result.success) {
                    addDebugLog('SUCCESS: Listing created successfully!');
                    alert('Listing created successfully!');
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                addDebugLog('ERROR in form submission: ' + error.message);
                alert('Error: ' + error.message);
            }
        }
        
        function testAllFunctions() {
            addDebugLog('=== TESTING ALL FUNCTIONS ===');
            
            // Test sale type toggle
            const immediateRadio = document.getElementById('saleTypeImmediate');
            const deliveryRadio = document.getElementById('saleTypeDelivery');
            const deliveryTimeGroup = document.getElementById('deliveryTimeGroup');
            
            addDebugLog(`Immediate radio exists: ${!!immediateRadio}`);
            addDebugLog(`Delivery radio exists: ${!!deliveryRadio}`);
            addDebugLog(`Delivery time group exists: ${!!deliveryTimeGroup}`);
            addDebugLog(`Current sale type: ${document.querySelector('input[name="saleType"]:checked')?.value}`);
            
            // Test image upload elements
            const uploadButton = document.getElementById('uploadButton');
            const fileUpload = document.getElementById('fileUpload');
            const imagePreview = document.getElementById('imagePreview');
            
            addDebugLog(`Upload button exists: ${!!uploadButton}`);
            addDebugLog(`File upload exists: ${!!fileUpload}`);
            addDebugLog(`Image preview exists: ${!!imagePreview}`);
            
            // Test location elements
            const locationInput = document.getElementById('location');
            const detectButton = document.getElementById('detectLocation');
            const manualButton = document.getElementById('manualLocation');
            
            addDebugLog(`Location input exists: ${!!locationInput}`);
            addDebugLog(`Detect button exists: ${!!detectButton}`);
            addDebugLog(`Manual button exists: ${!!manualButton}`);
            
            // Test Auth module
            addDebugLog(`Auth module loaded: ${typeof Auth !== 'undefined'}`);
            if (typeof Auth !== 'undefined') {
                addDebugLog(`User logged in: ${Auth.isLoggedIn()}`);
                if (Auth.isLoggedIn()) {
                    addDebugLog(`Current user: ${Auth.getCurrentUser().username}`);
                }
            }
            
            addDebugLog('=== TEST COMPLETE ===');
        }
    </script>
</body>
</html>