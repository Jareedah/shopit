<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Marketplace Issues - LocalMarket</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .issue { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç Marketplace Issues Debug Console</h1>
    
    <div class="debug-section">
        <h2>üö® Critical Issues to Fix</h2>
        <div class="issue">
            <h3>Issue 1: Dashboard Orders Widget</h3>
            <p><strong>Problem:</strong> Shows notification badge but no order details</p>
            <button onclick="testSellerOrdersWidget()">Test Seller Orders Widget</button>
            <div id="sellerOrdersTest"></div>
        </div>
        
        <div class="issue">
            <h3>Issue 2: Dashboard Listings Widget</h3>
            <p><strong>Problem:</strong> User's posted items don't appear in "Your Listings"</p>
            <button onclick="testUserListingsWidget()">Test User Listings Widget</button>
            <div id="userListingsTest"></div>
        </div>
        
        <div class="issue">
            <h3>Issue 3: Order History 404 Errors</h3>
            <p><strong>Problem:</strong> All order history links return 404</p>
            <button onclick="testOrderHistoryLinks()">Test Order History Links</button>
            <div id="orderHistoryTest"></div>
        </div>
        
        <div class="issue">
            <h3>Issue 4: No Inventory Management</h3>
            <p><strong>Problem:</strong> No stock quantity in listings, no inventory tracking</p>
            <button onclick="testInventorySystem()">Test Inventory System</button>
            <div id="inventoryTest"></div>
        </div>
        
        <div class="issue">
            <h3>Issue 5: No Stock Depletion Logic</h3>
            <p><strong>Problem:</strong> Items can be purchased indefinitely</p>
            <button onclick="testStockDepletion()">Test Stock Depletion</button>
            <div id="stockDepletionTest"></div>
        </div>
    </div>

    <div class="debug-section">
        <h2>üîß Quick Fixes</h2>
        <button onclick="generateSampleData()">Generate Sample Data</button>
        <button onclick="clearAllData()">Clear All Data</button>
        <button onclick="fixListingsData()">Fix Listings Data</button>
        <div id="quickFixResults"></div>
    </div>

    <script src="assets/js/core/api.js"></script>
    <script src="assets/js/modules/auth.js"></script>
    <script src="assets/js/modules/seller-orders.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!Auth.isLoggedIn()) {
                alert('Please login first to test marketplace functionality');
                window.location.href = 'auth/login.html';
                return;
            }
        });
        
        async function testSellerOrdersWidget() {
            const resultsDiv = document.getElementById('sellerOrdersTest');
            resultsDiv.innerHTML = '<p>Testing seller orders widget...</p>';
            
            try {
                const user = Auth.getCurrentUser();
                
                // Test if SellerOrders module is available
                if (typeof SellerOrders === 'undefined') {
                    throw new Error('SellerOrders module not loaded');
                }
                
                // Test initialization
                await SellerOrders.init(user.id);
                
                // Check localStorage for orders
                const sellerOrders = JSON.parse(localStorage.getItem('sellerOrders') || '[]');
                
                // Test container existence
                const container = document.getElementById('sellerOrdersList');
                const containerExists = !!container;
                
                resultsDiv.innerHTML = `
                    <div class="${sellerOrders.length > 0 ? 'success' : 'info'}">
                        <h4>Seller Orders Widget Test Results:</h4>
                        <p><strong>SellerOrders module:</strong> ${typeof SellerOrders !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded'}</p>
                        <p><strong>Container exists:</strong> ${containerExists ? '‚úÖ Yes' : '‚ùå No'}</p>
                        <p><strong>Orders in localStorage:</strong> ${sellerOrders.length}</p>
                        <p><strong>User ID:</strong> ${user.id}</p>
                        
                        <h5>Sample Orders in Storage:</h5>
                        <pre>${JSON.stringify(sellerOrders, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Seller Orders Widget Test: FAILED</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testUserListingsWidget() {
            const resultsDiv = document.getElementById('userListingsTest');
            resultsDiv.innerHTML = '<p>Testing user listings widget...</p>';
            
            try {
                const user = Auth.getCurrentUser();
                
                // Test search API with sellerId filter
                const response = await fetch('api/search/query.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: '',
                        sellerId: user.id,
                        sortBy: 'date'
                    })
                });
                
                const result = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="${result.success ? 'success' : 'error'}">
                        <h4>User Listings Widget Test Results:</h4>
                        <p><strong>API Response:</strong> ${result.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                        <p><strong>User ID:</strong> ${user.id}</p>
                        <p><strong>Listings Found:</strong> ${result.data?.length || 0}</p>
                        
                        ${result.data && result.data.length > 0 ? `
                            <h5>User's Listings:</h5>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        ` : `
                            <p><strong>Issue:</strong> No listings found for user ${user.id}</p>
                            <p><strong>Solution:</strong> Check if listings.json has data with correct sellerId</p>
                        `}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå User Listings Widget Test: FAILED</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testOrderHistoryLinks() {
            const resultsDiv = document.getElementById('orderHistoryTest');
            resultsDiv.innerHTML = '<p>Testing order history links...</p>';
            
            const linksToTest = [
                '../dashboard/orders.html',
                '../orders/history.html',
                '../orders/details.html'
            ];
            
            let testResults = '<div class="info"><h4>Order History Links Test:</h4>';
            
            for (const link of linksToTest) {
                try {
                    const response = await fetch(link);
                    const status = response.status;
                    testResults += `<p><strong>${link}:</strong> ${status === 200 ? '‚úÖ Working' : `‚ùå ${status} Error`}</p>`;
                } catch (error) {
                    testResults += `<p><strong>${link}:</strong> ‚ùå Failed (${error.message})</p>`;
                }
            }
            
            testResults += '<p><strong>Solution:</strong> Create missing order history pages</p></div>';
            resultsDiv.innerHTML = testResults;
        }
        
        async function testInventorySystem() {
            const resultsDiv = document.getElementById('inventoryTest');
            resultsDiv.innerHTML = '<p>Testing inventory system...</p>';
            
            try {
                // Check if listing creation form has stock field
                const response = await fetch('listings/create.html');
                const html = await response.text();
                const hasStockField = html.includes('id="stock"');
                
                // Check if listings data has stock information
                const listingsResponse = await fetch('api/search/query.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: '', limit: 1 })
                });
                
                const listingsResult = await listingsResponse.json();
                const hasStockInData = listingsResult.data?.[0]?.hasOwnProperty('stock');
                
                resultsDiv.innerHTML = `
                    <div class="${hasStockField && hasStockInData ? 'success' : 'error'}">
                        <h4>Inventory System Test Results:</h4>
                        <p><strong>Stock field in create form:</strong> ${hasStockField ? '‚úÖ Present' : '‚ùå Missing'}</p>
                        <p><strong>Stock data in listings:</strong> ${hasStockInData ? '‚úÖ Present' : '‚ùå Missing'}</p>
                        
                        ${listingsResult.data?.[0] ? `
                            <h5>Sample Listing Data:</h5>
                            <pre>${JSON.stringify(listingsResult.data[0], null, 2)}</pre>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Inventory System Test: FAILED</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testStockDepletion() {
            const resultsDiv = document.getElementById('stockDepletionTest');
            resultsDiv.innerHTML = '<p>Testing stock depletion logic...</p>';
            
            // This would test if purchase flow checks stock availability
            resultsDiv.innerHTML = `
                <div class="info">
                    <h4>Stock Depletion Test:</h4>
                    <p><strong>Current Status:</strong> ‚ùå Not implemented</p>
                    <p><strong>Required:</strong> Add stock checking to checkout flow</p>
                    <p><strong>Required:</strong> Add out-of-stock indicators to listings</p>
                    <p><strong>Required:</strong> Prevent purchases when stock = 0</p>
                </div>
            `;
        }
        
        async function generateSampleData() {
            const resultsDiv = document.getElementById('quickFixResults');
            resultsDiv.innerHTML = '<p>Generating sample data...</p>';
            
            try {
                const user = Auth.getCurrentUser();
                
                // Generate sample order for current user
                const sampleOrder = {
                    id: 'order_debug_' + Date.now(),
                    listingId: 'listing_001',
                    listingTitle: 'Debug Test Item',
                    buyerId: 'debug_buyer_001',
                    buyerName: 'Debug Buyer',
                    sellerId: user.id,
                    quantity: 1,
                    price: 50.00,
                    total_amount: 51.00,
                    seller_amount: 50.00,
                    status: 'pending',
                    escrow_status: 'funds_held',
                    created_at: new Date().toISOString(),
                    isNewOrder: true
                };
                
                // Store sample order
                const existingOrders = JSON.parse(localStorage.getItem('sellerOrders') || '[]');
                existingOrders.push(sampleOrder);
                localStorage.setItem('sellerOrders', JSON.stringify(existingOrders));
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Sample Data Generated</h4>
                        <p>Sample order created for user: ${user.id}</p>
                        <p>Refresh dashboard to see the order</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Sample Data Generation: FAILED</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function clearAllData() {
            localStorage.removeItem('sellerOrders');
            localStorage.removeItem('userListings');
            document.getElementById('quickFixResults').innerHTML = `
                <div class="info">
                    <h4>üóëÔ∏è All Data Cleared</h4>
                    <p>Cleared sellerOrders and userListings from localStorage</p>
                </div>
            `;
        }
        
        async function fixListingsData() {
            const resultsDiv = document.getElementById('quickFixResults');
            resultsDiv.innerHTML = '<p>Fixing listings data...</p>';
            
            try {
                // Copy sample listings to main listings
                const response = await fetch('data/sample-listings.json');
                const sampleData = await response.json();
                
                // Add stock field to all listings if missing
                if (sampleData.data) {
                    sampleData.data.forEach(listing => {
                        if (!listing.hasOwnProperty('stock')) {
                            listing.stock = Math.floor(Math.random() * 10) + 1; // Random stock 1-10
                        }
                    });
                }
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Listings Data Analysis</h4>
                        <p>Sample listings loaded: ${sampleData.data?.length || 0}</p>
                        <p>First listing has stock field: ${sampleData.data?.[0]?.hasOwnProperty('stock') ? 'Yes' : 'No'}</p>
                        
                        <h5>Sample Listing:</h5>
                        <pre>${JSON.stringify(sampleData.data?.[0], null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Fix Listings Data: FAILED</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>