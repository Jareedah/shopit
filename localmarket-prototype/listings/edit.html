<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Listing - LocalMarket</title>
    <link rel="stylesheet" href="../assets/css/base/reset.css">
    <link rel="stylesheet" href="../assets/css/base/variables.css">
    <link rel="stylesheet" href="../assets/css/base/typography.css">
    <link rel="stylesheet" href="../assets/css/layout/header.css">
    <link rel="stylesheet" href="../assets/css/components/buttons.css">
    <link rel="stylesheet" href="../assets/css/components/forms.css">
    <link rel="stylesheet" href="../assets/css/components/cards.css">
    <link rel="stylesheet" href="../assets/css/pages/listing-create.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">LocalMarket</h1>
            <nav class="navigation">
                <a href="../dashboard/index.html" class="nav-link">Dashboard</a>
                <a href="../search/index.html" class="nav-link">Search</a>
                <a href="../index.html" class="nav-link">Home</a>
                <span id="userWelcome"></span>
                <a href="#" id="logoutLink" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h2>‚úèÔ∏è Edit Listing</h2>
                <p>Update your product or service details</p>
            </div>

            <div id="loadingState" class="loading-state">
                <p>Loading listing details...</p>
            </div>

            <div id="errorState" class="error-state hidden">
                <h3>Error</h3>
                <p>Unable to load listing details</p>
                <a href="../dashboard/index.html" class="btn btn-primary">Back to Dashboard</a>
            </div>

            <div id="editForm" class="edit-form hidden">
                <form id="listingEditForm" class="listing-form">
                    <div class="form-section">
                        <h3>üìù Basic Information</h3>
                        
                        <div class="form-group">
                            <label for="title">Title*</label>
                            <input type="text" id="title" name="title" required maxlength="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description*</label>
                            <textarea id="description" name="description" rows="4" required maxlength="500"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">Category*</label>
                                <select id="category" name="category" required>
                                    <option value="">Select a category</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="clothing">Clothing & Fashion</option>
                                    <option value="home">Home & Garden</option>
                                    <option value="sports">Sports & Recreation</option>
                                    <option value="books">Books & Media</option>
                                    <option value="services">Services</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="price">Price* ($)</label>
                                <input type="number" id="price" name="price" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="stock">Stock Quantity*</label>
                                <input type="number" id="stock" name="stock" min="0" max="9999" required>
                                <small class="form-help">Current units available for sale</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="tags">Tags</label>
                            <input type="text" id="tags" name="tags" placeholder="e.g., vintage, handmade, professional">
                            <small class="form-help">Separate tags with commas</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìç Location</h3>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" readonly>
                            <div class="location-actions">
                                <button type="button" id="detectLocation" class="btn btn-secondary">üìç Detect Location</button>
                                <button type="button" id="manualLocation" class="btn btn-secondary">‚úèÔ∏è Enter Manually</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üñºÔ∏è Images</h3>
                        <div id="imagePreview" class="image-preview-container">
                            <!-- Current images will be loaded here -->
                        </div>
                        <div class="image-upload-section">
                            <input type="file" id="fileUpload" accept="image/*" multiple style="display: none;">
                            <button type="button" id="uploadButton" class="btn btn-secondary">üìÅ Upload Images</button>
                            <button type="button" id="cameraCapture" class="btn btn-secondary">üì∑ Take Photo</button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                        <button type="button" id="deleteListing" class="btn btn-danger">üóëÔ∏è Delete Listing</button>
                        <a href="../dashboard/index.html" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteModal" class="modal hidden">
                <div class="modal-overlay"></div>
                <div class="modal-content">
                    <h3>üóëÔ∏è Delete Listing</h3>
                    <p>Are you sure you want to delete this listing?</p>
                    <div id="deleteWarnings" class="delete-warnings">
                        <!-- Warnings about pending orders will appear here -->
                    </div>
                    <div class="modal-actions">
                        <button id="confirmDelete" class="btn btn-danger">Yes, Delete</button>
                        <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/core/api.js"></script>
    <script src="../assets/js/core/utils.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/modules/location.js"></script>
    <script src="../assets/js/modules/camera.js"></script>
    <script src="../assets/js/modules/image-upload.js"></script>
    
    <script>
        let currentListing = null;
        let listingId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!Auth.isLoggedIn()) {
                window.location.href = '../auth/login.html';
                return;
            }
            
            const user = Auth.getCurrentUser();
            document.getElementById('userWelcome').textContent = `Welcome, ${user.username}`;
            
            // Get listing ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            listingId = urlParams.get('id');
            
            if (!listingId) {
                showError('No listing ID specified');
                return;
            }
            
            // Load listing details
            loadListingForEdit(listingId);
            
            // Setup event listeners
            setupEventListeners();
            
            // Logout functionality
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                Auth.logout();
                window.location.href = '../auth/login.html';
            });
        });
        
        async function loadListingForEdit(id) {
            try {
                const response = await API.post('../api/listings/get.php', { id: id });
                
                if (response.success) {
                    currentListing = response.listing;
                    
                    // Check if user owns this listing
                    const user = Auth.getCurrentUser();
                    if (currentListing.sellerId !== user.id) {
                        showError('You can only edit your own listings');
                        return;
                    }
                    
                    // Populate form with current data
                    populateForm(currentListing);
                    
                    // Show form
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('editForm').classList.remove('hidden');
                    
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Error loading listing:', error);
                showError('Unable to load listing: ' + error.message);
            }
        }
        
        function populateForm(listing) {
            // Basic information
            document.getElementById('title').value = listing.title || '';
            document.getElementById('description').value = listing.description || '';
            document.getElementById('category').value = listing.category || '';
            document.getElementById('price').value = listing.price || '';
            document.getElementById('stock').value = listing.stock || 1;
            document.getElementById('tags').value = listing.tags ? listing.tags.join(', ') : '';
            
            // Location
            if (listing.location) {
                document.getElementById('location').value = listing.location.address || '';
                LocationService.setCurrentLocation(listing.location);
            }
            
            // Images
            if (listing.images && listing.images.length > 0) {
                displayCurrentImages(listing.images);
            }
        }
        
        function displayCurrentImages(images) {
            const container = document.getElementById('imagePreview');
            let imagesHtml = '<h4>Current Images:</h4><div class="current-images">';
            
            images.forEach((image, index) => {
                imagesHtml += `
                    <div class="image-item">
                        <img src="../uploads/${image}" alt="Listing image ${index + 1}" 
                             onerror="this.src='../assets/images/placeholder.jpg'">
                        <button type="button" class="remove-image" onclick="removeCurrentImage(${index})">‚ùå</button>
                    </div>
                `;
            });
            
            imagesHtml += '</div>';
            container.innerHTML = imagesHtml;
        }
        
        function setupEventListeners() {
            // Form submission
            document.getElementById('listingEditForm').addEventListener('submit', handleFormSubmit);
            
            // Delete listing
            document.getElementById('deleteListing').addEventListener('click', showDeleteConfirmation);
            
            // Delete modal
            document.getElementById('confirmDelete').addEventListener('click', confirmDeleteListing);
            document.getElementById('cancelDelete').addEventListener('click', hideDeleteModal);
            
            // Image upload
            document.getElementById('uploadButton').addEventListener('click', () => {
                document.getElementById('fileUpload').click();
            });
            
            document.getElementById('fileUpload').addEventListener('change', handleImageUpload);
            
            // Location detection
            document.getElementById('detectLocation').addEventListener('click', detectLocation);
            document.getElementById('manualLocation').addEventListener('click', enterLocationManually);
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                // Get form data
                const formData = new FormData();
                const locationData = LocationService.getCurrentLocation();
                
                const listingData = {
                    id: listingId,
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    category: document.getElementById('category').value,
                    price: parseFloat(document.getElementById('price').value),
                    stock: parseInt(document.getElementById('stock').value) || 1,
                    tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                    location: locationData || {
                        address: document.getElementById('location').value || 'Location not specified',
                        lat: 0,
                        lng: 0
                    }
                };
                
                // Add listing data to form
                formData.append('listingData', JSON.stringify(listingData));
                
                // Add new images if any
                const imageFiles = ImageUpload.getFiles();
                imageFiles.forEach(file => {
                    formData.append('images[]', file);
                });
                
                // Submit to update API
                const response = await fetch('../api/listings/update.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Listing updated successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '../dashboard/index.html';
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error updating listing:', error);
                showNotification('Error updating listing: ' + error.message, 'error');
            } finally {
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Save Changes';
            }
        }
        
        async function showDeleteConfirmation() {
            try {
                // Check for pending orders
                const response = await fetch('../api/orders/seller-orders.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sellerId: Auth.getCurrentUser().id })
                });
                
                const result = await response.json();
                const pendingOrders = result.orders ? result.orders.filter(o => 
                    o.listingId === listingId && 
                    ['pending', 'confirmed', 'processing', 'shipped'].includes(o.status)
                ) : [];
                
                const warningsDiv = document.getElementById('deleteWarnings');
                
                if (pendingOrders.length > 0) {
                    warningsDiv.innerHTML = `
                        <div class="warning-message">
                            <h4>‚ö†Ô∏è Warning: Active Orders</h4>
                            <p>This listing has ${pendingOrders.length} pending order(s):</p>
                            <ul>
                                ${pendingOrders.map(order => `
                                    <li>Order ${order.id} - ${order.buyerName} - $${order.seller_amount} - Status: ${order.status}</li>
                                `).join('')}
                            </ul>
                            <p><strong>Deleting this listing will:</strong></p>
                            <ul>
                                <li>‚ùå Cancel all pending orders</li>
                                <li>üí∞ Trigger automatic refunds</li>
                                <li>üìß Notify all affected buyers</li>
                            </ul>
                        </div>
                    `;
                } else {
                    warningsDiv.innerHTML = `
                        <div class="safe-message">
                            <p>‚úÖ Safe to delete - no pending orders</p>
                        </div>
                    `;
                }
                
                document.getElementById('deleteModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error checking pending orders:', error);
                showNotification('Error checking orders: ' + error.message, 'error');
            }
        }
        
        async function confirmDeleteListing() {
            try {
                const deleteBtn = document.getElementById('confirmDelete');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                
                const response = await fetch('../api/listings/delete.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        listingId: listingId,
                        sellerId: Auth.getCurrentUser().id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('üóëÔ∏è Listing deleted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '../dashboard/index.html';
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error deleting listing:', error);
                showNotification('Error deleting listing: ' + error.message, 'error');
            } finally {
                document.getElementById('confirmDelete').disabled = false;
                document.getElementById('confirmDelete').textContent = 'Yes, Delete';
            }
        }
        
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            
            if (message) {
                document.querySelector('#errorState p').textContent = message;
            }
        }
        
        function showNotification(message, type = 'info') {
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
        
        // Placeholder functions for image and location handling
        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            if (typeof ImageUpload !== 'undefined') {
                ImageUpload.handleFileSelect(e);
            } else {
                showNotification('Image upload functionality loading...', 'info');
            }
        }
        
        function removeCurrentImage(index) {
            if (currentListing && currentListing.images) {
                currentListing.images.splice(index, 1);
                displayCurrentImages(currentListing.images);
                showNotification('Image removed. Save changes to confirm.', 'info');
            }
        }
        
        async function detectLocation() {
            try {
                if (typeof LocationService !== 'undefined') {
                    const location = await LocationService.detectLocation();
                    document.getElementById('location').value = location.address;
                    showNotification('üìç Location detected!', 'success');
                } else {
                    showNotification('Location service loading...', 'info');
                }
            } catch (error) {
                showNotification('Error detecting location: ' + error.message, 'error');
            }
        }
        
        function enterLocationManually() {
            const address = prompt('Enter your location address:');
            if (address) {
                document.getElementById('location').value = address;
                LocationService.setCurrentLocation({
                    address: address,
                    lat: 0,
                    lng: 0
                });
                showNotification('üìç Location updated!', 'success');
            }
        }
    </script>
    
    <style>
        .hidden { display: none; }
        .loading-state, .error-state { text-align: center; padding: 40px; }
        .edit-form { max-width: 800px; margin: 0 auto; }
        .form-section { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .form-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; }
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); }
        .modal-content { position: relative; background: white; margin: 10% auto; padding: 20px; max-width: 500px; border-radius: 8px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .delete-warnings { margin: 15px 0; }
        .warning-message { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; }
        .safe-message { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; }
        .current-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .image-item { position: relative; }
        .image-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 5px; }
        .remove-image { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
    </style>
</body>
</html>