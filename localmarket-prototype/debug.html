<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - LocalMarket</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>LocalMarket Debug Console</h1>
    
    <div class="debug-section">
        <h2>API Connectivity Tests</h2>
        <button onclick="testBasicAPI()">Test Basic PHP</button>
        <button onclick="testSimpleLogin()">Test Simple Login</button>
        <button onclick="testLogin()">Test Login API</button>
        <button onclick="testRegister()">Test Register API</button>
        <button onclick="testDataFiles()">Test Data Files</button>
        <button onclick="testFullWorkflow()">Test Complete Workflow</button>
        <button onclick="testListingCreation()">Test Listing Creation</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>File Structure Check</h2>
        <button onclick="checkFileStructure()">Check Files</button>
        <div id="fileResults"></div>
    </div>
    
    <div class="debug-section">
        <h2>JavaScript Module Tests</h2>
        <button onclick="testAuthModule()">Test Auth Module</button>
        <button onclick="testAPIModule()">Test API Module</button>
        <div id="jsResults"></div>
    </div>

    <script>
        async function testBasicAPI() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing basic PHP functionality...</p>';
            
            try {
                const response = await fetch('api/debug/test.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({test: true})
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Basic PHP Test: SUCCESS</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Basic PHP Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>This indicates PHP scripts are not executing or there's a server configuration issue.</p>
                    </div>
                `;
            }
        }
        
        async function testSimpleLogin() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing simple login (minimal dependencies)...</p>';
            
            try {
                const response = await fetch('api/debug/simple-login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({username: 'admin1'})
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="${data.success ? 'success' : 'error'}">
                        <h3>${data.success ? '✅' : '❌'} Simple Login Test: ${data.success ? 'SUCCESS' : 'FAILED'}</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Simple Login Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>This indicates a fundamental PHP or server issue.</p>
                    </div>
                `;
            }
        }
        
        async function testLogin() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing login API...</p>';
            
            try {
                const response = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({username: 'admin1'})
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="${data.success ? 'success' : 'error'}">
                        <h3>${data.success ? '✅' : '❌'} Login Test: ${data.success ? 'SUCCESS' : 'FAILED'}</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Login Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>This indicates the login API endpoint has issues.</p>
                    </div>
                `;
            }
        }
        
        async function testRegister() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing register API...</p>';
            
            try {
                const response = await fetch('api/auth/register.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'test' + Math.floor(Math.random() * 1000),
                        userData: {
                            name: 'Test User',
                            email: 'test@example.com'
                        }
                    })
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="${data.success ? 'success' : 'error'}">
                        <h3>${data.success ? '✅' : '❌'} Register Test: ${data.success ? 'SUCCESS' : 'FAILED'}</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Register Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>This indicates the register API endpoint has issues.</p>
                    </div>
                `;
            }
        }
        
        async function testDataFiles() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing data file access...</p>';
            
            try {
                // Test reading users.json
                const response = await fetch('api/debug/test.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({test: 'data_files'})
                });
                
                const data = await response.json();
                
                let statusClass = 'success';
                let statusIcon = '✅';
                let statusText = 'SUCCESS';
                
                if (!data.success || !data.data_dir_exists || !data.users_file_exists) {
                    statusClass = 'error';
                    statusIcon = '❌';
                    statusText = 'FAILED';
                }
                
                resultsDiv.innerHTML = `
                    <div class="${statusClass}">
                        <h3>${statusIcon} Data Files Test: ${statusText}</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        ${!data.data_dir_exists ? '<p><strong>Issue:</strong> Data directory not found</p>' : ''}
                        ${!data.users_file_exists ? '<p><strong>Issue:</strong> users.json file not found</p>' : ''}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Data Files Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>Cannot access data files or PHP endpoint.</p>
                    </div>
                `;
            }
        }
        
        async function testDataFiles() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing data file access and structure...</p>';
            
            try {
                // Test basic data file access first
                const basicTest = await fetch('api/debug/test.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({test: 'data_access'})
                });
                
                const basicData = await basicTest.json();
                
                // Test actual data reading
                const dataTest = await fetch('api/debug/simple-login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({username: 'admin1'})
                });
                
                const loginData = await dataTest.json();
                
                let html = '<div class="success"><h3>✅ Data Files Test: SUCCESS</h3>';
                html += '<h4>File Access Status:</h4>';
                html += `<p>📁 Data directory exists: ${basicData.data_dir_exists ? '✅' : '❌'}</p>`;
                html += `<p>📄 users.json exists: ${basicData.users_file_exists ? '✅' : '❌'}</p>`;
                html += '<h4>Data Reading Test:</h4>';
                html += `<p>📖 User data readable: ${loginData.success ? '✅' : '❌'}</p>`;
                if (loginData.success && loginData.debug) {
                    html += `<p>👥 Users in database: ${loginData.debug.users_count || 'Unknown'}</p>`;
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Data Files Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                        <p>Cannot access or read data files.</p>
                    </div>
                `;
            }
        }
        
        async function testFullWorkflow() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing complete user workflow...</p>';
            
            try {
                let html = '<div class="success"><h3>🔄 Complete Workflow Test</h3>';
                
                // Test 1: Register new user
                const randomUser = 'demo' + Math.floor(Math.random() * 1000);
                const registerResponse = await fetch('api/auth/register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: randomUser,
                        userData: { name: 'Demo User', email: 'demo@test.com' }
                    })
                });
                const registerData = await registerResponse.json();
                
                html += `<p>1. Registration: ${registerData.success ? '✅' : '❌'} (${randomUser})</p>`;
                
                if (registerData.success) {
                    // Test 2: Login with new user
                    const loginResponse = await fetch('api/auth/login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({username: randomUser})
                    });
                    const loginData = await loginResponse.json();
                    
                    html += `<p>2. Login: ${loginData.success ? '✅' : '❌'}</p>`;
                    
                    if (loginData.success) {
                        html += `<p>3. User Role: ${loginData.user.role}</p>`;
                        html += `<p>4. Session Created: ✅</p>`;
                    }
                }
                
                // Test 3: Admin login
                const adminResponse = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({username: 'admin1'})
                });
                const adminData = await adminResponse.json();
                
                html += `<p>5. Admin Login: ${adminData.success ? '✅' : '❌'}</p>`;
                if (adminData.success) {
                    html += `<p>6. Admin Role: ${adminData.user.role === 'admin' ? '✅' : '❌'}</p>`;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Workflow Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testListingCreation() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>Testing listing creation system...</p>';
            
            try {
                // First login to get session
                const loginResponse = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({username: 'admin1'})
                });
                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    throw new Error('Login failed: ' + loginData.message);
                }
                
                // Test listing creation debug endpoint
                const testData = {
                    title: 'Test Product Debug',
                    description: 'Testing listing creation functionality',
                    category: 'electronics',
                    price: 99.99,
                    tags: ['test', 'debug'],
                    location: 'Test Location'
                };
                
                const debugResponse = await fetch('api/debug/test-listing.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const debugData = await debugResponse.json();
                
                let html = `<div class="${debugData.success ? 'success' : 'error'}">`;
                html += `<h3>${debugData.success ? '✅' : '❌'} Listing Creation Debug</h3>`;
                html += '<h4>System Status:</h4>';
                html += `<p>📁 Uploads directory exists: ${debugData.debug?.uploads_dir_exists ? '✅' : '❌'}</p>`;
                html += `<p>✏️ Uploads directory writable: ${debugData.debug?.uploads_dir_writable ? '✅' : '❌'}</p>`;
                html += `<p>📄 Listings file exists: ${debugData.debug?.listings_file_exists ? '✅' : '❌'}</p>`;
                html += `<p>💾 Data directory writable: ${debugData.debug?.data_dir_writable ? '✅' : '❌'}</p>`;
                html += `<p>👤 User session: ${debugData.debug?.session_user || 'None'}</p>`;
                
                if (debugData.debug?.parsed_listing_data) {
                    html += '<h4>Data Parsing:</h4>';
                    html += `<p>📝 Data received: ✅</p>`;
                    html += `<p>❌ Missing fields: ${debugData.debug.missing_fields?.length || 0}</p>`;
                    html += `<p>✅ Validation: ${debugData.debug.validation_passed ? 'Passed' : 'Failed'}</p>`;
                }
                
                html += '<h4>Debug Details:</h4>';
                html += `<pre>${JSON.stringify(debugData.debug, null, 2)}</pre>`;
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Listing Creation Test: FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function checkFileStructure() {
            const resultsDiv = document.getElementById('fileResults');
            const requiredFiles = [
                'api/auth/login.php',
                'api/auth/register.php',
                'api/core/Auth.php',
                'api/core/DataManager.php',
                'data/users.json',
                'assets/js/modules/auth.js',
                'assets/js/core/api.js'
            ];
            
            let html = '<h3>File Structure Check</h3>';
            
            requiredFiles.forEach(file => {
                // We can't actually check file existence from JavaScript in browser
                // This is just for documentation
                html += `<p>📁 ${file} - Expected to exist</p>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function testAuthModule() {
            const resultsDiv = document.getElementById('jsResults');
            
            try {
                if (typeof Auth === 'undefined') {
                    throw new Error('Auth module not loaded');
                }
                
                if (typeof Auth.login !== 'function') {
                    throw new Error('Auth.login method not available');
                }
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Auth Module: LOADED</h3>
                        <p>Auth module is properly loaded and has required methods.</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Auth Module: FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function testAPIModule() {
            const resultsDiv = document.getElementById('jsResults');
            
            try {
                if (typeof API === 'undefined') {
                    throw new Error('API module not loaded');
                }
                
                if (typeof API.post !== 'function') {
                    throw new Error('API.post method not available');
                }
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ API Module: LOADED</h3>
                        <p>API module is properly loaded and has required methods.</p>
                        <p>Base URL: "${API.getConfig().baseUrl}"</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ API Module: FAILED</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
    
    <!-- Load the same scripts as the main pages -->
    <script src="assets/js/core/app.js"></script>
    <script src="assets/js/core/api.js"></script>
    <script src="assets/js/core/utils.js"></script>
    <script src="assets/js/modules/auth.js"></script>
</body>
</html>